{% extends "base.html" %}
{% load static %}

{% block title %}Tutoring{% endblock %}
{% block heading %}Tutoring{% endblock %}

{% block header %}
<link rel="stylesheet" href="https://unpkg.com/@fullcalendar/core@4.4.0/main.css" />
<link rel="stylesheet" href="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.css" />
<link rel="stylesheet" href="https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.css" />

<script src="https://unpkg.com/@fullcalendar/core@4.4.0/main.js"></script>
<script src="https://unpkg.com/@fullcalendar/daygrid@4.4.0/main.js"></script>
<script src="https://unpkg.com/@fullcalendar/timegrid@4.4.0/main.js"></script>

<script>
    function nav_button_onclick(class_name, default_count, incr) {
        const urlParams = new URLSearchParams(window.location.search);

        if (class_name == "fc-today-button") {
            urlParams.delete("nav");
        } else {
            if (urlParams.has("nav")) {
                urlParams.set("nav", parseInt(urlParams.get("nav")) + incr);
            } else {
                urlParams.set("nav", default_count);
            }
        }

        if (history.pushState) {
            var newurl = window.location.origin + window.location.pathname + "?" + urlParams.toString();
            window.history.replaceState({ path: newurl }, "", newurl);
        }

        decorate_nav_buttons();
    }

    function decorate_nav_buttons() {
        document
            .getElementsByClassName("fc-next-button")[0]
            .addEventListener("click", function () { nav_button_onclick("fc-next-button", "1", 1); });
        document
            .getElementsByClassName("fc-prev-button")[0]
            .addEventListener("click", function () { nav_button_onclick("fc-prev-button", "-1", -1); });
        document
            .getElementsByClassName("fc-today-button")[0]
            .addEventListener("click", function () { nav_button_onclick("fc-today-button", "0", 0); });
    }
</script>

<style>
    a.fc-event {
        width: 15em;
    }

    .tooltip {
        color: black;
        background-color: WhiteSmoke;
        width: 200%;
        border-radius: 0.15em;
        min-height: 3em;
        padding: 0;
        position: relative;
        top: calc(-75% - 1px);
        left: -1px;
        z-index: 10;
        display: none;
    }

    .tooltip-title {
        text-align: center;
        margin-bottom: 0.5em;
        color: white;
        font-size: 125%;
        border-radius: inherit;
    }

    .tooltip-body {
        margin-left: 0.5em;
        margin-right: 0.5em;
    }

    .tooltip-tutor-img {
        display: inline-block;
        margin-right: 0.5em;
        width: 12em;
        height: 12em;
    }

    .tooltip-tutor-desc {
        display: inline-block;
        width: 15em;
        vertical-align: top;
    }
</style>

<script type="text/javascript">
    var selector_decorator;

    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            // General options
            plugins: ['timeGrid'],
            //defaultView: 'timeGridDay',
            defaultView: 'timeGridWeek',
            defaultDate: '{{ offset|date:"c" }}',
            header: {
                left: 'prev,next',
                center: 'title',
                right: 'today',
            },
            //height: "auto",
            height: "auto",
            contentHeight: "auto",
            aspectRatio: 1, // Makes the calendar wider relative to its height
            eventMaxStack: 1,
            allDaySlot: false,
            navLinks: true,
            eventLimit: false,
            firstDay: 1, //sets monday to first day
            hiddenDays: [0, 6], //hides sunday and saturday
            views: {
                timeGrid: {
                    minTime: "13:00:00",
                    maxTime: "17:00:00",
                    nowIndicator: true,
                }
            },
            eventSources: [
                {
                    url: '{% url "tutoring:slots" %}',
                    extraParams: function () {
                        function get_filtered_ids(id) {
                            var select_el = document.getElementById(id);
                            if (!select_el.nextElementSibling) {
                                return {};
                            }

                            var text_id_mapping = {};
                            var select_options = select_el.options;
                            for (let i = 0; i < select_options.length; i++) {
                                text_id_mapping[select_options[i].text] = select_options[i].value;
                            }

                            var select_choices = select_el.nextElementSibling.getElementsByTagName("li");
                            var select_choice_ids = [];
                            for (let i = 0; i < select_choices.length - 1; i++) {
                                select_choice_ids.push(text_id_mapping[select_choices[i].title]);
                            }

                            return select_choice_ids.join(",");
                        }
                        return {
                            course_filter: get_filtered_ids("id_course"),
                            tutor_filter: get_filtered_ids("id_tutor"),
                        }
                    }
                }
            ],
            /*events: [
                {
                    id: '1',
                    title: 'Math Tutoring',
                    start: '2025-04-12T10:00:00',
                    end: '2025-04-12T11:00:00',
                    backgroundColor: '#007bff',
                    tooltip_title: 'Algebra with Mr. Smith',
                    tutors: [
                        {
                            name: 'Mr. Smith',
                            courses: 'Algebra I, Algebra II',
                            picture: '/static/images/mr_smith.jpg',
                            alt: 'Photo of Mr. Smith',
                        }
                    ]
                }
            ],*/
            eventRender: function (eventRenderInfo) {
                var tooltip = document.createElement("div");
                tooltip.id = eventRenderInfo.event.id + "tooltip";
                tooltip.classList.add("tooltip");

                var tooltip_title = document.createElement("div");
                tooltip.append(tooltip_title);
                tooltip_title.classList.add("tooltip-title");
                tooltip_title.style.backgroundColor = eventRenderInfo.event.backgroundColor;
                tooltip_title.append(eventRenderInfo.event.extendedProps.tooltip_title);

                var tooltip_body = document.createElement("div");
                tooltip.append(tooltip_body);
                tooltip_body.classList.add("tooltip-body");

                eventRenderInfo.event.extendedProps.tutors.forEach(t => {
                    var tutor_img = document.createElement("img");
                    tutor_img.classList.add("tooltip-tutor-img");
                    tutor_img.src = t.picture;
                    tutor_img.alt = t.alt;

                    var tutor_desc = document.createElement("div");
                    tutor_desc.classList.add("tooltip-tutor-desc");

                    var tutor_name = document.createElement("div");
                    tutor_name.style.fontWeight = "bold";
                    tutor_name.append(t.name);

                    tutor_desc.append(tutor_name);
                    tutor_desc.append("Courses: " + t.courses);

                    tooltip_body.append(tutor_img);
                    tooltip_body.append(tutor_desc);
                });

                eventRenderInfo.el.append(tooltip);
            },
            eventMouseEnter: function (mouseEnterInfo) {
                document.getElementsByClassName("fc-time-grid-container")[0].style.overflow = "visible";

                document.getElementById(mouseEnterInfo.event.id + "tooltip").style.display = "block";
                mouseEnterInfo.el.style.zIndex = 10;
            },
            eventMouseLeave: function (mouseLeaveInfo) {
                document.getElementById(mouseLeaveInfo.event.id + "tooltip").style.display = "none";
                mouseLeaveInfo.el.style.zIndex = 1;
            }
        });

        calendar.render();

        const calendarHeader = calendarEl.querySelector('.fc-center');
        if (calendarHeader) {
            calendarHeader.innerHTML = '<div style="font-weight: bold; font-size: 1.6em;">Soda 345</div>';
        }

        var calendarEl2 = document.getElementById('calendar2');
        var calendar2 = new FullCalendar.Calendar(calendarEl2, {
            // General options
            plugins: ['timeGrid'],
            //defaultView: 'timeGridDay',
            defaultView: 'timeGridWeek',
            defaultDate: '{{ offset|date:"c" }}',
            header: {
                left: 'prev,next',
                center: '',
                right: 'today',
            },
            //height: "auto",
            height: "auto",
            contentHeight: "auto",
            aspectRatio: 1, // Makes the calendar wider relative to its height
            eventMaxStack: 1,
            allDaySlot: false,
            navLinks: true,
            eventLimit: false,
            firstDay: 1, //sets monday to first day
            hiddenDays: [0, 6], //hides sunday and saturday
            views: {
                timeGrid: {
                    minTime: "13:00:00",
                    maxTime: "17:00:00",
                    nowIndicator: true,
                }
            },
            eventSources: [//modify to display correct prodev sources
                {
                    url: '{% url "tutoring:slots" %}',
                    extraParams: function () {
                        function get_filtered_ids(id) {
                            var select_el = document.getElementById(id);
                            if (!select_el.nextElementSibling) {
                                return {};
                            }

                            var text_id_mapping = {};
                            var select_options = select_el.options;
                            for (let i = 0; i < select_options.length; i++) {
                                text_id_mapping[select_options[i].text] = select_options[i].value;
                            }

                            var select_choices = select_el.nextElementSibling.getElementsByTagName("li");
                            var select_choice_ids = [];
                            for (let i = 0; i < select_choices.length - 1; i++) {
                                select_choice_ids.push(text_id_mapping[select_choices[i].title]);
                            }

                            return select_choice_ids.join(",");
                        }
                        return {
                            course_filter: get_filtered_ids("id_course"),
                            tutor_filter: get_filtered_ids("id_tutor"),
                        }
                    }
                }
            ],
            /*events: [
                {
                    id: '1',
                    title: 'Math Tutoring',
                    start: '2025-04-12T10:00:00',
                    end: '2025-04-12T11:00:00',
                    backgroundColor: '#007bff',
                    tooltip_title: 'Algebra with Mr. Smith',
                    tutors: [
                        {
                            name: 'Mr. Smith',
                            courses: 'Algebra I, Algebra II',
                            picture: '/static/images/mr_smith.jpg',
                            alt: 'Photo of Mr. Smith',
                        }
                    ]
                }
            ],*/
            eventRender: function (eventRenderInfo) {
                var tooltip = document.createElement("div");
                tooltip.id = eventRenderInfo.event.id + "tooltip";
                tooltip.classList.add("tooltip");

                var tooltip_title = document.createElement("div");
                tooltip.append(tooltip_title);
                tooltip_title.classList.add("tooltip-title");
                tooltip_title.style.backgroundColor = eventRenderInfo.event.backgroundColor;
                tooltip_title.append(eventRenderInfo.event.extendedProps.tooltip_title);

                var tooltip_body = document.createElement("div");
                tooltip.append(tooltip_body);
                tooltip_body.classList.add("tooltip-body");

                eventRenderInfo.event.extendedProps.tutors.forEach(t => {
                    var tutor_img = document.createElement("img");
                    tutor_img.classList.add("tooltip-tutor-img");
                    tutor_img.src = t.picture;
                    tutor_img.alt = t.alt;

                    var tutor_desc = document.createElement("div");
                    tutor_desc.classList.add("tooltip-tutor-desc");

                    var tutor_name = document.createElement("div");
                    tutor_name.style.fontWeight = "bold";
                    tutor_name.append(t.name);

                    tutor_desc.append(tutor_name);
                    tutor_desc.append("Courses: " + t.courses);

                    tooltip_body.append(tutor_img);
                    tooltip_body.append(tutor_desc);
                });

                eventRenderInfo.el.append(tooltip);
            },
            eventMouseEnter: function (mouseEnterInfo) {
                document.getElementsByClassName("fc-time-grid-container")[0].style.overflow = "visible";

                document.getElementById(mouseEnterInfo.event.id + "tooltip").style.display = "block";
                mouseEnterInfo.el.style.zIndex = 10;
            },
            eventMouseLeave: function (mouseLeaveInfo) {
                document.getElementById(mouseLeaveInfo.event.id + "tooltip").style.display = "none";
                mouseLeaveInfo.el.style.zIndex = 1;
            }
        });

        calendar2.render();

        const calendarHeader2 = calendarEl2.querySelector('.fc-center');
        if (calendarHeader2) {
            calendarHeader2.innerHTML = '<div style="font-weight: bold; font-size: 1.6em;">Prodev</div>';
        }

        function customizeTimeLabels() {
            // Select only major time slots (not minors)
            const majorTimeSlots = document.querySelectorAll('td.fc-time span');

            majorTimeSlots.forEach(span => {
                const originalTime = span.innerText.trim();
                if (originalTime) {
                    let hour = parseInt(originalTime);
                    const isPM = originalTime.includes('pm');

                    if (isPM && hour !== 12) {
                        hour += 12;
                    }
                    if (!isPM && hour === 12) {
                        hour = 0;
                    }

                    const nextHour = (hour + 1) % 24;

                    function formatHour(h) {
                        const period = h >= 12 ? 'pm' : 'am';
                        const h12 = h % 12 === 0 ? 12 : h % 12;
                        return h12 + period;
                    }

                    span.innerText = formatHour(hour) + "–" + formatHour(nextHour);
                }
            });
        }

        // Initial customization
        setTimeout(customizeTimeLabels, 0);

        selector_decorator = function () {
            calendar.refetchEvents();
        }
    });

    window.addEventListener("load", function () {
        decorate_nav_buttons();
    });

</script>
{% endblock %}

{% block content %}
<div style="text-align: center; overflow: auto;">
    <div style="width: 60em; margin: auto; display: inline-block; vertical-align: top; min-height: 50em;">
        <section id="calendar"></section>
        <section id="calendar2" style="margin-top: 3em;"></section>
    </div>

    <div style="display: inline-block; text-align: center; margin-left: 1em;">
        Filter by course
        <br>
        {{ form.course }}
        <br>

        Filter by tutor
        <br>
        {{ form.tutor }}
    </div>
</div>
{% endblock %}